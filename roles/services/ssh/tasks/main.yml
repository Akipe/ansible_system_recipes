---
# https://infosec.mozilla.org/guidelines/openssh
# https://www.cyberciti.biz/tips/linux-unix-bsd-openssh-server-best-practices.html

- name: Load tasks for Debian & derivate
  include_tasks: debian/main.yml
  when: ansible_distribution == "Debian" or ansible_distribution == "Ubuntu"

- name: Load tasks for Fedora
  include_tasks: fedora/main.yml
  when: ansible_distribution == "Fedora"

- name: Load tasks for Archlinux
  include_tasks: archlinux/main.yml
  when: ansible_distribution == "Archlinux"

- name: Open firewall for sshd 
  ansible.posix.firewalld:
    service: ssh
    zone: home
    state: enabled
    permanent: true
    immediate: yes
  when: ssh_firewall_firewalld

- name: Check if SSH key have being regenerate
  ansible.builtin.stat:
    path: /etc/ssh/.ansible_has_generate_keys
  register: is_ansible_has_generate_keys

- name: Generate Ed25519 key
  community.crypto.openssh_keypair:
    path: /etc/ssh/ssh_host_ed25519_key
    type: ed25519
    force: yes
  when: not is_ansible_has_generate_keys.stat.exists

- name: Generate RSA key
  community.crypto.openssh_keypair:
    path: /etc/ssh/ssh_host_rsa_key
    type: rsa
    size: "{{ ssh_keys_rsa_size }}"
    force: yes
  when: not is_ansible_has_generate_keys.stat.exists

- name: Generate ECDSA key
  community.crypto.openssh_keypair:
    path: /etc/ssh/ssh_host_ecdsa_key
    type: ecdsa
    size: "{{ ssh_keys_ecdsa_size }}"
    force: yes
  when: not is_ansible_has_generate_keys.stat.exists

- name: remove DSA key
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  with_items:
    - /etc/ssh/ssh_host_dsa_key
    - /etc/ssh/ssh_host_dsa_key.pub

- name: Set keys generate by Ansible
  ansible.builtin.file:
    path: /etc/ssh/.ansible_has_generate_keys
    state: touch
  when: not is_ansible_has_generate_keys.stat.exists

- name: Set public key for SSH
  ansible.posix.authorized_key:
    state: present
    user: "{{ item.name }}"
    key: "{{ item.public_key }}"
  with_items: "{{ ssh_users }}"

- name: Add config for SSH server
  ansible.builtin.template:
    src: ssh/sshd_config.j2
    dest: /etc/ssh/sshd_config
    owner: root
    group: root
    mode: u+rw,g+r,o+r
    validate: '/usr/sbin/sshd -t -f %s'
  notify: Restart SSH server

- name: set file permissions
  ansible.builtin.file:
    path: /etc/ssh
    owner: root
    group: root
    mode: 0755

- name: Start and enable SSH server
  ansible.builtin.systemd:
    name: sshd.service
    enabled: yes
    state: started
