---
- name: Install driver
  pacman:
    state: present
    name: "{{ intelgraphics_app_base_archlinux }}"

# Count generation intel from this page https://en.wikipedia.org/wiki/List_of_Intel_CPU_microarchitectures
- name: Define video acceleration type support (generation after 19)
  set_fact:
    video_acceleration_type: iHD
  when: hardware_gpu_vendor|int >= 19

- name: Define video acceleration type support (generation before 19)
  set_fact:
    video_acceleration_type: i965
  when: hardware_gpu_vendor|int < 19

- name: Install video acceleration support (iHD)
  pacman:
    state: present
    name: "{{ intelgraphics_app_video_iHD_archlinux }}"
  when: video_acceleration_type == "iHD"

- name: Install video acceleration support (i965)
  pacman:
    state: present
    name: "{{ intelgraphics_app_video_i965_archlinux }}"
  when: video_acceleration_type == "i965"

# - name: Install other video acceleration support (i965)
#   become: yes
#   become_user: ansible_aur
#   aur:
#     use: yay
#     skip_installed: true
#     aur_only: yes
#     name:
#       - intel-hybrid-codec-driver
#       - libva-intel-driver-hybrid
#   when: video_acceleration_type == "i965"

- name: Install GPGPU driver Beignet
  pacman:
    state: present
    name: "{{ intelgraphics_app_gpgpu_beignet_archlinux }}"
  when: hardware_gpu_vendor|int < 19

- name: Install GPGPU driver Intel compute runtime
  pacman:
    state: present
    name: "{{ intelgraphics_app_gpgpu_intelComputeRuntime_archlinux }}"
  when: hardware_gpu_vendor|int >= 19

# - name: Install GPGPU driver Intel Opencl
#   become: yes
#   become_user: ansible_aur
#   aur:
#     use: yay
#     skip_installed: true
#     aur_only: yes
#     name:
#       - intel-opencl
#   when: intelgraphic_gpgpu_driver == "intel-opencl"

- name: Enable video acceleration support globally (libva)
  lineinfile:
    path: /etc/environment
    regexp: '^LIBVA_DRIVER_NAME='
    line: 'LIBVA_DRIVER_NAME={{ video_acceleration_type }}'

- name: Enable video acceleration support globally (vdpau)
  lineinfile:
    path: /etc/environment
    regexp: '^VDPAU_DRIVER='
    line: 'VDPAU_DRIVER=va_gl'

- name: Enable GST vaapi for the iHD drivers
  lineinfile:
    path: /etc/environment
    regexp: '^GST_VAAPI_ALL_DRIVERS='
    line: 'GST_VAAPI_ALL_DRIVERS=1'
  when: hardware_gpu_vendor|int >= 19

- name: Enable video acceleration support for the user (libva and vdpau)
  become: yes
  become_user: "{{ user_name }}"
  template:
    src: environment.d/video_intel.conf.j2
    dest: "/home/{{ user_name }}/.config/environment.d/video_intel.conf"
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: u+rw,g+r,o+r

# - name: Create Xorg configuration directory
#   file:
#     path: /etc/X11/xorg.conf.d
#     state: directory
#     recurse: yes
#     owner: root
#     group: root
#     mode: u+rw,g+r,o+r

# - name: Enable options for intel graphic driver
#   template:
#     src: modprobe.d/i915.conf.j2
#     dest: /etc/modprobe.d/i915.conf
#     owner: root
#     group: root
#     mode: u+rwx,g+rx,o+rx
#   tags: debug

# - name: Add configuration for Xorg
#   template:
#     src: xorg.conf.d/20-intel.conf.j2
#     dest: /etc/X11/xorg.conf.d/20-intel.conf
#     owner: root
#     group: root
#     mode: u+rw,g+r,o+r
#   tags: debug
