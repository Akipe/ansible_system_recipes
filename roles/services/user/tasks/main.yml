---

- name: Create group wheel for sudo
  group:
    state: present
    name: wheel

- name: Creates users
  user:
    state:        present
    name:         "{{ item.username }}"
    password:     "{{ user_syncthing_password_hashed }}"
    create_home:  yes
    shell:        "{{ item.shell }}"
    groups: 
      - "{{ item.groups }}"
    append: yes
  loop: "{{ users_create }}"

- name: Append public key for SSH
  authorized_key:
    user: "{{ item.username }}"
    state: present
    manage_dir: yes
    key: "{{ item.public_key }}"
  loop: "{{ users_create }}"

- name: Create systemd user environment variables directory
  file:
    path: "/home/{{ item.username }}/.config/environment.d"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: u+rwx,g+rx,o+rx
  loop: "{{ users_create }}"

- name: Create systemd user binaries directory
  file:
    path: "/home/{{ item.username }}/.local/bin"
    state: directory
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: u+rwx,g+rx,o+rx
  loop: "{{ users_create }}"

- name: Fix home directory owner
  file:
    dest: "/home/{{ item.username }}"
    owner: "{{ item.username }}"
    group: "{{ item.username }}"
    mode: u=rwx,g=rx,o=rx
    recurse: yes
  loop: "{{ users_create }}"
