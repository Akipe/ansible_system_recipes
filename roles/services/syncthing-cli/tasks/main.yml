---

- name: Load tasks for Debian & derivate
  include_tasks: debian/main.yml
  when: ansible_distribution == "Debian" or ansible_distribution == "Ubuntu"

- name: Load tasks for Archlinux
  include_tasks: archlinux/main.yml
  when: ansible_distribution == "Archlinux"

- name: Create syncthing user
  user:
    state:        present
    shell:        /bin/bash
    name:         syncthing
    comment:      Syncthing user for syncthing service
    create_home:  yes
    append:       yes
  when: syncthing_cli_use_builtin_user

- name: Start and enable Syncthing service with syncthing user
  systemd:
    name: "syncthing@syncthing.service"
    state: started
    enabled: yes
  when: syncthing_cli_use_builtin_user

- name: Allow external access to administration
  lineinfile: 
    path: /home/syncthing/.config/syncthing/config.xml
    regexp: '^(.*)<address>127.0.0.1:(.*)$' 
    line: '        <address>0.0.0.0:8384</address>'
    backrefs: yes
  notify: Restart Syncthing for builtin user
  when: syncthing_cli_use_builtin_user

# - name: Find uid of user
#   command: "id -u {{ user_name }}"
#   register: user_uid
#   check_mode: no # Run even in check mode, otherwise the playbook fails with --check.
#   changed_when: false

- name: Start and active user Syncthing service (with user)
  become: yes
  become_user: "{{ user_name }}"
  # environment:
  #  XDG_RUNTIME_DIR: "/run/user/{{ user_uid.stdout }}"
  systemd:
    name: syncthing.service
    scope: user
    state: started
    enabled: yes
  when:
    - (role_syncthing_start_as_superuser is not defined) or (not role_syncthing_start_as_superuser)
    - not syncthing_cli_use_builtin_user

- name: Start and active user Syncthing service (with superuser)
  systemd:
    name: "syncthing@{{ user_name }}.service"
    state: started
    enabled: yes
  when:
    - (role_syncthing_start_as_superuser is defined) or (role_syncthing_start_as_superuser)
    - not syncthing_cli_use_builtin_user

- name: Open firewall for syncthing
  ansible.posix.firewalld:
    service: syncthing
    zone: home
    state: enabled
    permanent: true
    immediate: yes
  when: syncthing_cli_open_firewall

# todo: configure ~/.config/syncthing/config.xml

# 127.0.0.1:8384 > 0.0.0.0:8384